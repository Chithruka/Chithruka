<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chithruka Streamer</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://image.tmdb.org">
    
    <link href="https://fonts.googleapis.com/css2?family=BBH+Bartle&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --accent: #e50914; /* Netflix Red */
            --text-muted: #bfbfbf;
        }

        body {
            color: #f0f0f0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- Dynamic Background --- */
        #page-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at top left, #1a1a2e, #000000);
            background-size: cover; background-position: center; background-attachment: fixed;
            transition: background-image 0.7s ease-in-out; will-change: background-image;
        }

        #page-background::before {
            content: ''; position: absolute; inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }

        /* --- Glassmorphism --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-input, .glass-select {
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; backdrop-filter: blur(4px);
        }
        .glass-input:focus, .glass-select:focus {
            border-color: var(--accent); background: rgba(0, 0, 0, 0.5); outline: none;
        }

        /* --- NEW ANIMATED LOGO STYLES --- */
        .logo-wrapper {
            position: relative;
            cursor: pointer;
            z-index: 50;
            padding: 10px 0;
        }

        .logo-h2 {
            margin: 0; padding: 0;
            font-family: "BBH Bartle", "Impact", sans-serif; /* Fallback to Impact if font fails */
            font-weight: 400;
            font-style: normal;
            font-size: 3rem; /* Desktop Size */
            color: transparent; /* Hide base text */
            text-transform: uppercase;
            position: relative;
            line-height: 1;
            display: inline-block;
        }

        /* Top Half */
        .logo-h2 span:nth-child(1) {
            position: absolute;
            top: 0; left: 0;
            color: #fff;
            transition: 0.5s;
            clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%);
            overflow: hidden;
            width: 100%;
        }
        .logo-wrapper:hover .logo-h2 span:nth-child(1) {
            transform: translateY(-12px);
        }

        /* Bottom Half */
        .logo-h2 span:nth-child(2) {
            position: absolute;
            top: 0; left: 0;
            color: #fff;
            transition: 0.5s;
            clip-path: polygon(0 50%, 100% 50%, 100% 100%, 0 100%);
            overflow: hidden;
            width: 100%;
        }
        .logo-wrapper:hover .logo-h2 span:nth-child(2) {
            transform: translateY(12px);
        }

        /* Middle "STREAMER" Text */
        .logo-h2 span:nth-child(3) {
            position: absolute;
            top: 50%; left: 0;
            transform: translateY(-50%) scaleY(0);
            width: 100%; /* Match parent width */
            background: var(--accent); /* Theme Red */
            color: #fff;
            font-family: 'Inter', sans-serif;
            font-size: 0.25em; /* Small relative size */
            font-weight: 700;
            letter-spacing: 0.5em;
            text-align: center;
            transition: 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 20px;
        }
        .logo-wrapper:hover .logo-h2 span:nth-child(3) {
            transform: translateY(-50%) scaleY(1);
        }

        /* Mobile Logo Sizing */
        @media (max-width: 640px) {
            .logo-h2 { font-size: 2.2rem; }
            .logo-wrapper:hover .logo-h2 span:nth-child(1) { transform: translateY(-8px); }
            .logo-wrapper:hover .logo-h2 span:nth-child(2) { transform: translateY(8px); }
        }

        /* --- Navbar --- */
        .navbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 5%; margin-bottom: 20px; flex-wrap: wrap; gap: 20px;
            position: relative; z-index: 50;
        }
        @media (max-width: 640px) {
            .navbar { justify-content: center; flex-direction: column; }
            .search-group { width: 100%; justify-content: center; }
            #search-input { width: 100%; max-width: 100%; }
        }

        .search-group {
            display: flex; align-items: center; gap: 10px; flex-grow: 1;
            max-width: 600px; justify-content: flex-end; position: relative;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.05); color: var(--text-muted);
            padding: 10px 16px; border-radius: 50%; transition: all 0.3s;
            border: 1px solid transparent; cursor: pointer; flex-shrink: 0;
        }
        .filter-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; border-color: var(--accent); }

        #search-input {
            width: 100%; max-width: 300px; padding: 10px 40px 10px 20px;
            border-radius: 50px; transition: width 0.3s;
        }
        @media (min-width: 641px) { #search-input:focus { max-width: 400px; } }

        #search-results {
            position: absolute; top: 100%; right: 0; width: 100%; max-width: 400px;
            z-index: 50; margin-top: 10px; border-radius: 12px; overflow: hidden;
            max-height: 400px; overflow-y: auto;
        }
        .search-result-item {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            background: rgba(20, 20, 20, 0.95); cursor: pointer; transition: background 0.2s;
        }
        .search-result-item:hover { background: rgba(50, 50, 50, 0.95); }
        .result-poster { width: 40px; height: 60px; border-radius: 4px; object-fit: cover; background: #333; }

        /* --- Hero Slider --- */
        #hero-section {
            position: relative; width: 100%; height: 60vh;
            border-radius: 20px; overflow: hidden; margin-bottom: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: none; background: #000;
        }
        @media (min-width: 768px) { #hero-section { height: 550px; } }

        .hero-slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; transition: opacity 1s ease-in-out;
            background-size: cover; background-position: center;
        }
        .hero-slide.active { opacity: 1; }
        .hero-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 10%, rgba(0,0,0,0.5) 50%, transparent 100%);
            display: flex; align-items: flex-end; padding: 30px;
        }
        @media (min-width: 768px) {
            .hero-overlay {
                background: linear-gradient(to right, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 40%, transparent 100%);
                align-items: center; padding-left: 60px;
            }
        }
        .hero-content { max-width: 500px; z-index: 10; margin-bottom: 20px; }
        @media (min-width: 768px) { .hero-content { margin-bottom: 0; } }
        .hero-logo {
            max-width: 200px; max-height: 100px; object-fit: contain; object-position: left; margin-bottom: 10px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6));
        }
        @media (min-width: 768px) { .hero-logo { max-width: 350px; max-height: 150px; margin-bottom: 20px; } }
        .hero-text { font-size: 0.9rem; margin-bottom: 1rem; line-clamp: 2; -webkit-line-clamp: 2; display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; }
        @media (min-width: 768px) { .hero-text { font-size: 1.125rem; margin-bottom: 1.5rem; line-clamp: 3; -webkit-line-clamp: 3; } }
        .hero-indicators { position: absolute; bottom: 20px; right: 30px; display: flex; gap: 10px; z-index: 20; }
        .indicator { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.3); cursor: pointer; transition: all 0.3s; }
        .indicator.active { background: var(--accent); transform: scale(1.2); }

        /* --- TOP 10 NUMBERED SLIDER --- */
        .top-10-card {
            min-width: 160px; width: 160px; flex-shrink: 0;
            position: relative; margin-left: 25px; 
            cursor: pointer; transition: transform 0.3s;
        }
        .top-10-card:hover { transform: scale(1.05); z-index: 10; }
        
        .rank-number {
            position: absolute; bottom: -20px; left: -30px;
            font-size: 110px; font-weight: 900; line-height: 1;
            font-family: 'Inter', sans-serif;
            color: transparent;
            -webkit-text-stroke: 2px #fff;
            z-index: -1; 
            transition: all 0.3s ease;
        }
        
        .top-10-card:hover .rank-number {
            color: var(--accent); 
            -webkit-text-stroke: 0px; 
            text-shadow: 0 0 20px rgba(229, 9, 20, 0.6);
        }

        @media (max-width: 640px) {
            .top-10-card { min-width: 130px; width: 130px; margin-left: 15px; }
            .rank-number { font-size: 80px; left: -15px; bottom: -10px; }
        }
        .top-poster { width: 100%; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); background: #222; object-fit: cover; aspect-ratio: 2/3; }

        /* --- Episode Accordions (Per Season) --- */
        .season-accordion { margin-bottom: 8px; }
        .season-header {
            background: rgba(255,255,255,0.05); color: #fff; padding: 14px 18px;
            border-radius: 8px; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: background 0.2s; font-weight: 600;
        }
        .season-header:hover { background: rgba(255,255,255,0.1); }
        .season-content {
            background: rgba(0,0,0,0.2); 
            border-radius: 0 0 8px 8px; overflow: hidden;
            display: none; 
            padding-top: 5px;
        }
        .season-content.open { display: block; }

        .episode-rich-item {
            display: flex; gap: 15px; padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer; transition: background 0.2s;
        }
        .episode-rich-item:hover { background: rgba(255,255,255,0.05); }
        .episode-rich-item.active { background: rgba(229,9,20,0.15); border-left: 4px solid var(--accent); }
        
        .ep-still { width: 120px; height: 68px; flex-shrink: 0; border-radius: 6px; object-fit: cover; background: #222; }
        .ep-info { display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .ep-title { font-weight: 700; font-size: 0.9rem; color: #fff; margin-bottom: 2px; }
        .ep-overview { font-size: 0.75rem; color: #aaa; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- Footer --- */
        .site-footer {
            margin-top: auto;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            padding: 60px 0 40px;
        }
        .footer-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 40px; max-width: 1200px; margin: 0 auto; padding: 0 20px;
        }
        .footer-col h4 { color: #fff; font-weight: 700; margin-bottom: 20px; font-size: 1.1rem; }
        .footer-col ul { list-style: none; padding: 0; }
        .footer-col ul li { margin-bottom: 12px; }
        .footer-col a { color: var(--text-muted); text-decoration: none; transition: color 0.2s; font-size: 0.9rem; }
        .footer-col a:hover { color: var(--accent); }
        .footer-brand { 
            font-family: "BBH Bartle", sans-serif; /* Use the new font for footer brand too */
            font-size: 2.5rem; 
            color: #fff; 
            margin-bottom: 15px; 
            display: block; 
        }
        .copyright { text-align: center; color: #666; font-size: 0.8rem; margin-top: 60px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); }

        /* --- Standard Components --- */
        #player-iframe { width: 100%; aspect-ratio: 16 / 9; border: none; border-radius: 12px; background-color: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .server-btn { background: rgba(255, 255, 255, 0.05); color: #ccc; padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.05); flex-grow: 1; }
        .server-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
        .server-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 15px rgba(229, 9, 20, 0.4); }
        .action-btn { padding: 10px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .action-btn:active { transform: scale(0.96); }
        .btn-play { background: #fff; color: #000; }
        .btn-download { background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; }
        .btn-trailer { background: linear-gradient(135deg, #e50914, #b20710); color: white; }
        .btn-next { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; }
        .title-logo { max-width: 100%; max-height: 100px; width: auto; object-fit: contain; object-position: left; margin-bottom: 0.5rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); display: none; }
        @media (min-width: 768px) { .title-logo { max-width: 350px; max-height: 120px; } }
        .cast-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .cast-card { min-width: 80px; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .cast-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #333; margin-bottom: 5px; background: #222; }
        .cast-name { font-size: 0.75rem; color: #ddd; font-weight: 600; }
        .cast-char { font-size: 0.65rem; color: #888; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .scroll-card { min-width: 140px; width: 140px; flex-shrink: 0; background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .scroll-card { min-width: 160px; width: 160px; } }
        .scroll-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0,0,0,0.5); border-color: rgba(255,255,255,0.2); z-index: 10; }
        .poster-img { width: 100%; height: 200px; object-fit: cover; background-color: #222; }
        @media (min-width: 768px) { .poster-img { height: 230px; } }
        .card-body { padding: 12px; display: flex; flex-direction: column; gap: 4px; }
        .card-title { font-weight: 600; color: #fff; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; }
        .rating-badge { color: #ffd54d; font-weight: 700; }
        .scroll-btn { position: absolute; top: 50%; transform: translateY(-50%); z-index: 20; background: rgba(0, 0, 0, 0.6); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(4px); }
        .scroll-btn:hover { background: var(--accent); border-color: var(--accent); }
    </style>
</head>
<body>

<div id="page-background"></div>

<div class="container mx-auto px-4 flex-grow">

    <nav class="navbar">
        <div class="logo-wrapper" onclick="location.reload()">
            <h2 class="logo-h2">
                CHITHRUKA
                <span>CHITHRUKA</span>
                <span>CHITHRUKA</span>
                <span>STREAMER</span>
            </h2>
        </div>

        <div class="search-group">
            <button onclick="openFilterModal()" class="filter-btn" title="Filter Content">
                <i class="fas fa-sliders-h"></i>
            </button>
            <div class="relative w-full max-w-[300px] flex-grow">
                <input type="text" id="search-input" class="glass-input" placeholder="Search...">
                <i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm pointer-events-none"></i>
            </div>
            <ul id="search-results" class="glass-panel"></ul>
        </div>
    </nav>

    <div id="hero-section">
        <div id="hero-slides"></div>
        <div id="hero-indicators" class="hero-indicators"></div>
    </div>

    <div class="mb-12 relative" id="top10-section">
        <h2 class="text-xl md:text-2xl font-bold mb-6 text-white flex items-center px-2">
            <i class="fas fa-crown text-yellow-500 mr-3"></i> Top 10 Trending
        </h2>
        <div class="relative group px-2">
            <button class="scroll-btn left-0 -ml-4" onclick="scrollContainer('top10-container', -300)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div id="top10-container" class="flex flex-nowrap gap-6 pl-4 overflow-x-auto pb-8 scrollbar-hide scroll-smooth"></div>
            <button class="scroll-btn right-0 -mr-4" onclick="scrollContainer('top10-container', 300)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <div id="details-section" class="glass-panel p-6 md:p-8 rounded-2xl hidden mb-8">
        <div class="flex flex-col md:flex-row gap-8">
            <div class="flex-shrink-0 mx-auto md:mx-0 w-48 md:w-52">
                <img id="detail-poster" src="" alt="Poster" class="w-full rounded-xl shadow-2xl object-cover border border-gray-700" loading="lazy">
            </div>
            <div class="flex-grow min-w-0">
                <img id="detail-logo" src="" alt="Title Logo" class="title-logo" loading="lazy">
                <h2 id="detail-heading" class="text-3xl md:text-4xl font-bold mb-1 text-white"></h2>
                <p id="detail-tagline" class="text-gray-400 italic text-sm md:text-base mb-4"></p>
                <div class="flex flex-wrap items-center gap-4 md:gap-5 text-sm text-gray-300 mb-6">
                    <span id="detail-date" class="flex items-center"><i class="far fa-calendar-alt mr-2 text-accent"></i> <span></span></span>
                    <span id="detail-rating" class="flex items-center"><i class="fas fa-star text-yellow-500 mr-2"></i> <span></span></span>
                    <span id="detail-runtime" class="flex items-center"><i class="far fa-clock mr-2"></i> <span></span></span>
                    <span id="detail-status" class="flex items-center text-green-400 font-semibold"><i class="fas fa-info-circle mr-2"></i><span></span></span>
                </div>
                <div id="detail-genres" class="flex flex-wrap gap-2 mb-6"></div>
                <p id="detail-overview" class="text-gray-300 leading-relaxed text-sm md:text-base mb-6"></p>
                <div id="cast-container" class="mt-4">
                    <h4 class="text-sm font-bold text-gray-400 mb-3 uppercase tracking-wide">Top Cast</h4>
                    <div id="cast-list" class="cast-scroll scrollbar-hide"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="player-interface" class="hidden fade-in">
        <div class="mb-6 rounded-xl overflow-hidden shadow-2xl relative bg-black border border-gray-800">
            <iframe id="player-iframe" allowfullscreen></iframe>
        </div>
        <div class="glass-panel p-4 rounded-xl mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div id="server-buttons" class="flex flex-wrap gap-2"></div>
            <div class="flex flex-wrap gap-3 w-full md:w-auto">
                <button id="next-ep-btn" onclick="nextEpisode()" class="action-btn btn-next flex-grow md:flex-grow-0 hidden shadow-lg">
                    <i class="fas fa-step-forward mr-2"></i> Next
                </button>
                <button onclick="openTrailerModal()" class="action-btn btn-trailer flex-grow md:flex-grow-0 shadow-lg">
                    <i class="fab fa-youtube mr-2"></i> Trailer
                </button>
                <button onclick="openDownloadModal()" class="action-btn btn-download flex-grow md:flex-grow-0 shadow-lg">
                    <i class="fas fa-download mr-2"></i> DL
                </button>
            </div>
        </div>

        <div id="tv-controls" class="hidden mb-12">
            <h3 class="text-xl font-bold text-white mb-4">Seasons & Episodes</h3>
            <div id="seasons-container"></div>
        </div>
    </div>

    <div id="recommendations-section" class="mb-8 relative hidden">
        <h2 class="text-xl md:text-2xl font-bold mb-4 md:mb-6 text-white flex items-center px-2">
            <i class="fas fa-thumbs-up text-blue-500 mr-3"></i> You May Also Like
        </h2>
        <div class="relative group px-2">
            <button class="scroll-btn left-0 -ml-4" onclick="scrollContainer('recommendations-container', -300)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div id="recommendations-container" class="flex flex-nowrap gap-4 md:gap-5 overflow-x-auto pb-8 scrollbar-hide scroll-smooth"></div>
            <button class="scroll-btn right-0 -mr-4" onclick="scrollContainer('recommendations-container', 300)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <div class="mb-12 relative">
        <h2 id="trending-header" class="text-xl md:text-2xl font-bold mb-4 md:mb-6 text-white flex items-center px-2">
            <i class="fas fa-fire text-orange-500 mr-3"></i> Trending Now
        </h2>
        <div class="relative group px-2">
            <button id="scroll-left" class="scroll-btn left-0 -ml-4" onclick="scrollContainer('trending-container', -300)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div id="trending-container" class="flex flex-nowrap gap-4 md:gap-5 overflow-x-auto pb-8 scrollbar-hide scroll-smooth"></div>
            <button id="scroll-right" class="scroll-btn right-0 -mr-4" onclick="scrollContainer('trending-container', 300)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div id="infinite-loader" class="text-center text-xs text-gray-500 mt-2 hidden">
            <i class="fas fa-circle-notch fa-spin mr-2"></i>Loading more...
        </div>
    </div>
</div>

<footer class="site-footer">
    <div class="footer-grid">
        <div class="footer-col">
            <span class="footer-brand">CHITHRUKA</span>
            <p class="text-gray-400 text-sm leading-relaxed">
                Premium streaming experience with a modern touch. Discover, watch, and enjoy your favorite movies and TV shows in high quality.
            </p>
        </div>
        <div class="footer-col">
            <h4>Explore</h4>
            <ul>
                <li><a href="#" onclick="location.reload()">Home</a></li>
                <li><a href="#" onclick="document.getElementById('trending-header').scrollIntoView({behavior:'smooth'})">Trending</a></li>
                <li><a href="#" onclick="openFilterModal()">Discover</a></li>
                <li><a href="#">Top IMDb</a></li>
            </ul>
        </div>
        <div class="footer-col">
            <h4>Legal</h4>
            <ul>
                <li><a href="#">Terms of Service</a></li>
                <li><a href="#">Privacy Policy</a></li>
                <li><a href="#">DMCA</a></li>
            </ul>
        </div>
        <div class="footer-col">
            <h4>Social</h4>
            <ul>
                <li><a href="#"><i class="fab fa-twitter mr-2"></i> Twitter</a></li>
                <li><a href="#"><i class="fab fa-instagram mr-2"></i> Instagram</a></li>
                <li><a href="#"><i class="fab fa-discord mr-2"></i> Discord</a></li>
            </ul>
        </div>
    </div>
    <div class="copyright">
        &copy; <span id="year"></span> Chithruka Streamer. All rights reserved.
    </div>
</footer>

<div id="filter-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
    <div class="glass-panel p-6 rounded-2xl max-w-sm w-full relative shadow-2xl">
        <button onclick="closeFilterModal()" class="absolute top-3 right-4 text-gray-400 hover:text-white text-xl"><i class="fas fa-times"></i></button>
        <h3 class="text-xl font-bold mb-4 text-center text-white">Discover</h3>
        <div class="flex flex-col gap-4">
            <div>
                <label class="block text-xs text-gray-400 mb-1">Type</label>
                <select id="filter-type" class="glass-select w-full p-2 rounded-lg" onchange="loadGenres()">
                    <option value="movie">Movie</option>
                    <option value="tv">TV Show</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">Genre</label>
                <select id="filter-genre" class="glass-select w-full p-2 rounded-lg"><option value="">Any Genre</option></select>
            </div>
            <div class="flex gap-4">
                <div class="flex-1"><label class="block text-xs text-gray-400 mb-1">Year</label><input type="number" id="filter-year" class="glass-input w-full p-2 rounded-lg" placeholder="2023"></div>
                <div class="flex-1"><label class="block text-xs text-gray-400 mb-1">Min Rating</label><input type="number" id="filter-rating" class="glass-input w-full p-2 rounded-lg" placeholder="8.0"></div>
            </div>
            <button onclick="applyFilter()" class="mt-2 w-full p-3 bg-red-600 hover:bg-red-700 rounded-lg text-white font-bold transition">Apply Filter</button>
        </div>
    </div>
</div>

<div id="trailer-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center hidden z-50 p-4">
    <div class="w-full max-w-4xl relative">
        <button onclick="closeTrailerModal()" class="absolute -top-10 right-0 text-white hover:text-red-500 text-2xl"><i class="fas fa-times"></i> Close</button>
        <div class="relative w-full aspect-video rounded-xl overflow-hidden shadow-2xl bg-black">
            <iframe id="trailer-iframe" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
    </div>
</div>

<div id="download-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
    <div class="glass-panel p-6 rounded-2xl max-w-sm w-full relative shadow-2xl">
        <button onclick="closeDownloadModal()" class="absolute top-3 right-4 text-gray-400 hover:text-white text-xl"><i class="fas fa-times"></i></button>
        <h3 class="text-xl font-bold mb-2 text-center text-white">Download</h3>
        <p class="text-gray-400 text-sm text-center mb-6" id="download-modal-subtitle">Select a source</p>
        <div class="flex flex-col gap-3">
            <a id="dl-link-1" href="#" target="_blank" class="block w-full p-4 bg-gray-800/50 hover:bg-green-600/20 border border-gray-600 hover:border-green-500 rounded-xl text-center transition-all group"><div class="font-bold text-white mb-1">Source 1 (VidSrc)</div><div class="text-xs text-gray-400 group-hover:text-green-300">Standard Quality</div></a>
            <a id="dl-link-2" href="#" target="_blank" class="block w-full p-4 bg-gray-800/50 hover:bg-blue-600/20 border border-gray-600 hover:border-blue-500 rounded-xl text-center transition-all group"><div class="font-bold text-white mb-1">Source 2 (GoDrive)</div><div class="text-xs text-gray-400 group-hover:text-blue-300">Fast Server</div></a>
        </div>
    </div>
</div>

<div id="message-box" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg hidden z-50 text-white font-semibold max-w-sm text-center"></div>

<script>
    const TMDB_API_KEY = '92850a79e50917b8cc19623455ae2240'; 
    const BASE_TMDB_URL = 'https://api.themoviedb.org/3';
    const TMDB_IMG_BASE_URL = 'https://image.tmdb.org/t/p/w92'; 
    const TMDB_POSTER_MD = 'https://image.tmdb.org/t/p/w342'; 
    const TMDB_POSTER_LG = 'https://image.tmdb.org/t/p/w300';
    const TMDB_POSTER_XL = 'https://image.tmdb.org/t/p/w500'; 
    const TMDB_BACKDROP_WEB = 'https://image.tmdb.org/t/p/w1280'; 
    const TMDB_STILL_SZ = 'https://image.tmdb.org/t/p/w300';

    let mediaType = 'movie'; let TMDB_ID = null; let IMDB_ID = null; 
    let currentTitle = ""; let currentSeason = 1; let currentEpisode = 1;
    let episodeData = []; let currentServerIndex = 0; 
    let trendingPage = 1; let isTrendingLoading = false;
    let loadedIds = new Set(); let loadedGenreType = null; let heroInterval;
    const requestCache = new Map();

    async function fetchCached(url) {
        if (requestCache.has(url)) return requestCache.get(url);
        try { const res = await fetch(url); const data = await res.json(); requestCache.set(url, data); return data; } catch (e) { throw e; }
    }

    const SERVER_URLS = [
        { name: "Server 1 (VidSrc)", movie: "https://vidsrc.to/embed/movie/[ID]", tv: "https://vidsrc.to/embed/tv/[ID]/[S]/[E]" },
        { name: "Server 2 (VidSrc VIP)", movie: "https://vidsrc.vip/embed/movie/[ID]", tv: "https://vidsrc.vip/embed/tv/[ID]/[S]/[E]" },
        { name: "Server 3 (VidLink)", movie: "https://vidlink.pro/movie/[ID]", tv: "https://vidlink.pro/tv/[ID]/[S]/[E]" },
        { name: "Server 4 (SuperEmbed)", movie: "https://multiembed.mov/?video_id=[ID]&tmdb=1", tv: "https://multiembed.mov/?video_id=[ID]&tmdb=1&s=[S]&e=[E]" },
        { name: "Server 5 (AutoEmbed)", movie: "https://autoembed.co/movie/tmdb/[ID]", tv: "https://autoembed.co/tv/tmdb/[ID]-[S]-[E]" }
    ];
    const DOWNLOAD_URLS = { source1: { movie: "https://dl.vidsrc.vip/movie/[ID]", tv: "https://dl.vidsrc.vip/tv/[ID]/[S]/[E]" }, source2: { movie: "https://godriveplayer.com/download.php?type=movie&tmdb=[ID]", tv: "https://godriveplayer.com/download.php?type=series&tmdb=[ID]&season=[S]&episode=[E]" } };

    const playerInterface = document.getElementById('player-interface');
    const playerIframe = document.getElementById('player-iframe');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const messageBox = document.getElementById('message-box');
    const tvControls = document.getElementById('tv-controls');
    const seasonsContainer = document.getElementById('seasons-container');
    const currentEpisodeInfo = document.getElementById('current-episode-info');
    const detailsSection = document.getElementById('details-section');
    const downloadModal = document.getElementById('download-modal');
    const trailerModal = document.getElementById('trailer-modal');
    const trailerIframe = document.getElementById('trailer-iframe');
    const trendingContainer = document.getElementById('trending-container');
    const top10Container = document.getElementById('top10-container');
    const recommendationsSection = document.getElementById('recommendations-section');
    const recommendationsContainer = document.getElementById('recommendations-container');
    const filterModal = document.getElementById('filter-modal');
    const infiniteLoader = document.getElementById('infinite-loader');
    const heroSection = document.getElementById('hero-section');
    const pageBackground = document.getElementById('page-background');

    function showMessage(text, isError=false) { messageBox.textContent=text; messageBox.className=`fixed bottom-5 right-5 p-4 rounded-lg shadow-lg z-50 text-white font-semibold max-w-sm text-center ${isError?'bg-red-700':'bg-blue-600'}`; messageBox.classList.remove('hidden'); setTimeout(()=>messageBox.classList.add('hidden'),3000); }
    window.scrollContainer = function(id, amount) { document.getElementById(id).scrollBy({ left: amount, behavior: 'smooth' }); }

    trendingContainer.addEventListener('scroll', () => { if (trendingContainer.scrollLeft + trendingContainer.clientWidth >= trendingContainer.scrollWidth - 200) loadTrending(); });

    async function loadTrending() {
        if (isTrendingLoading) return;
        isTrendingLoading = true; infiniteLoader.classList.remove('hidden');
        try {
            const data = await fetchCached(`${BASE_TMDB_URL}/trending/all/day?api_key=${TMDB_API_KEY}&page=${trendingPage}`);
            if (data.results && data.results.length > 0) {
                if (trendingPage === 1) {
                    initHero(data.results.slice(0, 5));
                    renderTop10(data.results.slice(0, 10));
                }
                trendingPage++;
                renderCards(data.results, trendingContainer, true);
            }
        } catch (error) { console.error(error); } finally { isTrendingLoading = false; infiniteLoader.classList.add('hidden'); }
    }

    async function initHero(items) {
        const slidesContainer = document.getElementById('hero-slides');
        const indicatorsContainer = document.getElementById('hero-indicators');
        slidesContainer.innerHTML = ''; indicatorsContainer.innerHTML = '';
        heroSection.style.display = 'block';
        const validItems = items.filter(i => i.media_type !== 'person');
        for (let i = 0; i < validItems.length; i++) {
            const item = validItems[i];
            const title = item.title || item.name;
            const backdrop = item.backdrop_path ? `${TMDB_BACKDROP_WEB}${item.backdrop_path}` : null;
            if (!backdrop) continue;
            let logoUrl = null;
            try {
                const imgData = await fetchCached(`${BASE_TMDB_URL}/${item.media_type}/${item.id}/images?api_key=${TMDB_API_KEY}&include_image_language=en,null`);
                const logo = imgData.logos.find(l => l.iso_639_1 === 'en') || imgData.logos[0];
                if (logo) logoUrl = `${TMDB_POSTER_XL}${logo.file_path}`;
            } catch(e) {}
            const slide = document.createElement('div');
            slide.className = `hero-slide ${i===0?'active':''}`;
            slide.style.backgroundImage = `url('${backdrop}')`;
            slide.innerHTML = `<div class="hero-overlay"><div class="hero-content fade-in">${logoUrl ? `<img src="${logoUrl}" class="hero-logo" alt="${title}" loading="lazy">` : `<h1 class="text-3xl md:text-5xl font-bold mb-4 text-white drop-shadow-lg">${title}</h1>`}<p class="hero-text text-white text-gray-200">${item.overview}</p><button onclick="selectContent(${item.id}, '${title.replace(/'/g, "\\'")}', '${item.media_type}')" class="action-btn btn-play text-base md:text-lg px-6 md:px-8 py-2 md:py-3"><i class="fas fa-play mr-2"></i> Watch Now</button></div></div>`;
            slidesContainer.appendChild(slide);
            const ind = document.createElement('div');
            ind.className = `indicator ${i===0?'active':''}`;
            ind.onclick = () => showHeroSlide(i);
            indicatorsContainer.appendChild(ind);
        }
        if (heroInterval) clearInterval(heroInterval);
        heroInterval = setInterval(() => {
            let activeIndex = Array.from(document.querySelectorAll('.hero-slide')).findIndex(s => s.classList.contains('active'));
            showHeroSlide((activeIndex + 1) % validItems.length);
        }, 6000);
    }
    function showHeroSlide(index) {
        const slides = document.querySelectorAll('.hero-slide'); const indicators = document.querySelectorAll('.indicator');
        slides.forEach(s => s.classList.remove('active')); indicators.forEach(i => i.classList.remove('active'));
        if (slides[index]) slides[index].classList.add('active'); if (indicators[index]) indicators[index].classList.add('active');
    }

    function renderTop10(items) {
        top10Container.innerHTML = '';
        items.forEach((item, index) => {
            if (item.media_type === 'person') return;
            const title = item.title || item.name;
            const poster = item.poster_path ? `${TMDB_POSTER_MD}${item.poster_path}` : null;
            if(!poster) return;
            const card = document.createElement('div');
            card.className = 'top-10-card';
            card.innerHTML = `<div class="rank-number">${index + 1}</div><img src="${poster}" class="top-poster" loading="lazy" alt="${title}">`;
            card.onclick = () => selectContent(item.id, title, item.media_type);
            top10Container.appendChild(card);
        });
    }

    async function loadRecommendations(type, id) {
        recommendationsContainer.innerHTML = ''; recommendationsSection.classList.add('hidden');
        try {
            const data = await fetchCached(`${BASE_TMDB_URL}/${type}/${id}/recommendations?api_key=${TMDB_API_KEY}`);
            if (data.results && data.results.length > 0) {
                recommendationsSection.classList.remove('hidden');
                renderCards(data.results.map(item => ({ ...item, media_type: type })), recommendationsContainer, false);
            }
        } catch (e) { console.error(e); }
    }

    function renderCards(items, container, trackIds) {
        items.forEach(item => {
            if (trackIds) { if (loadedIds.has(item.id) || item.media_type === 'person') return; loadedIds.add(item.id); } 
            else if (item.media_type === 'person') return;
            const title = item.title || item.name;
            const poster = item.poster_path ? `${TMDB_POSTER_MD}${item.poster_path}` : null;
            if (!poster) return;
            const card = document.createElement('div'); card.className = 'scroll-card';
            card.innerHTML = `<img src="${poster}" class="poster-img" loading="lazy" alt="${title}"><div class="card-body"><div class="card-title" title="${title}">${title}</div><div class="card-meta"><span>${(item.release_date||item.first_air_date||'N/A').substring(0,4)}</span><span class="rating-badge"><i class="fas fa-star mr-1"></i>${item.vote_average?item.vote_average.toFixed(1):'NR'}</span></div></div>`;
            card.onclick = () => selectContent(item.id, title, item.media_type);
            container.appendChild(card);
        });
    }

    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout); const query = searchInput.value.trim();
        if (query.length < 2) { searchResults.innerHTML = ''; return; }
        searchTimeout = setTimeout(async () => {
            try {
                const data = await fetchCached(`${BASE_TMDB_URL}/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&include_adult=false`);
                searchResults.innerHTML = '';
                if (!data.results.length) searchResults.innerHTML = '<li class="p-4 text-center text-gray-400">No results found.</li>';
                data.results.forEach(item => {
                    const title = item.title || item.name;
                    const img = item.poster_path || item.profile_path ? `${TMDB_IMG_BASE_URL}${item.poster_path || item.profile_path}` : 'https://placehold.co/40x60/333/999?text=N/A';
                    if(!title) return;
                    const li = document.createElement('li'); li.className = 'search-result-item';
                    li.innerHTML = `<img src="${img}" class="result-poster" loading="lazy"><div class="text-left"><div class="font-bold text-white text-sm">${title}</div><div class="text-xs text-gray-400">${item.media_type.toUpperCase()}</div></div>`;
                    li.onclick = () => item.media_type === 'person' ? loadActorCredits(item.id, item.name) : selectContent(item.id, title, item.media_type);
                    searchResults.appendChild(li);
                });
            } catch(e){}
        }, 500);
    });

    async function loadActorCredits(personId, personName) {
        searchResults.innerHTML = ''; searchInput.value = ''; trendingContainer.innerHTML = ''; loadedIds.clear(); trendingPage = 1;
        heroSection.style.display = 'none'; document.getElementById('top10-section').style.display = 'none';
        document.getElementById('trending-header').innerHTML = `<i class="fas fa-user-circle text-purple-500 mr-3"></i> Featuring ${personName}`;
        try {
            const data = await fetchCached(`${BASE_TMDB_URL}/person/${personId}/movie_credits?api_key=${TMDB_API_KEY}`);
            const results = data.cast.sort((a,b) => b.popularity - a.popularity).map(i => ({...i, media_type: 'movie'}));
            renderCards(results, trendingContainer, true);
            document.getElementById('trending-header').scrollIntoView({behavior:'smooth'});
        } catch(e) { showMessage("Could not load filmography", true); }
    }

    // Modal & Filter Logic
    window.openFilterModal = () => { filterModal.classList.remove('hidden'); loadGenres(); };
    window.closeFilterModal = () => filterModal.classList.add('hidden');
    async function loadGenres() {
        const type = document.getElementById('filter-type').value; if (loadedGenreType === type) return;
        const select = document.getElementById('filter-genre'); select.innerHTML = '<option value="">Any Genre</option>';
        try {
            const data = await fetchCached(`${BASE_TMDB_URL}/genre/${type}/list?api_key=${TMDB_API_KEY}`);
            data.genres.forEach(g => { const opt = document.createElement('option'); opt.value = g.id; opt.textContent = g.name; select.appendChild(opt); });
            loadedGenreType = type;
        } catch(e){}
    }
    async function applyFilter() {
        const type = document.getElementById('filter-type').value; const genre = document.getElementById('filter-genre').value;
        const year = document.getElementById('filter-year').value; const rating = document.getElementById('filter-rating').value;
        closeFilterModal(); searchResults.innerHTML = ''; searchInput.value = ''; heroSection.style.display = 'none'; document.getElementById('top10-section').style.display = 'none';
        trendingContainer.innerHTML = ''; loadedIds.clear(); trendingPage = 1;
        let url = `${BASE_TMDB_URL}/discover/${type}?api_key=${TMDB_API_KEY}&sort_by=popularity.desc&page=1`;
        if (year) url += type === 'movie' ? `&primary_release_year=${year}` : `&first_air_date_year=${year}`;
        if (genre) url += `&with_genres=${genre}`; if (rating) url += `&vote_average.gte=${rating}`;
        try {
            const data = await fetchCached(url);
            document.getElementById('trending-header').innerHTML = `<i class="fas fa-filter text-green-500 mr-3"></i> Filtered Results`;
            renderCards(data.results.map(i => ({...i, media_type: type})), trendingContainer, true);
        } catch(e) { showMessage("Filter failed", true); }
    }

    // Main Selection
    window.selectContent = async function(id, title, type) {
        TMDB_ID = id; mediaType = type; currentTitle = title;
        searchResults.innerHTML = ''; searchInput.value = '';
        heroSection.style.display = 'none'; document.getElementById('top10-section').style.display = 'none';
        playerInterface.classList.add('hidden'); detailsSection.classList.add('hidden');
        playerIframe.src = "about:blank";
        if (mediaType === 'tv') await fetchShowDetails(id, title); else await fetchMovieDetails(id, title);
        loadRecommendations(mediaType, id);
        setTimeout(() => detailsSection.scrollIntoView({ behavior: 'smooth' }), 100);
    }

    async function fetchMovieDetails(id, title) {
        tvControls.classList.add('hidden');
        try {
            const data = await fetchCached(`${BASE_TMDB_URL}/movie/${id}?api_key=${TMDB_API_KEY}&append_to_response=images,external_ids,credits&include_image_language=en,null`);
            if (data.external_ids) IMDB_ID = data.external_ids.imdb_id;
            renderDetails(data, title); playerInterface.classList.remove('hidden'); updatePlayer();
        } catch (e) { showMessage("Failed to load details.", true); }
    }

    // --- TV SERIES LOGIC (OPTIMIZED) ---
    async function fetchShowDetails(id, title) {
        try {
            const data = await fetchCached(`${BASE_TMDB_URL}/tv/${id}?api_key=${TMDB_API_KEY}&append_to_response=images,credits&include_image_language=en,null`);
            renderDetails(data, title);
            // Render Season Headers Only (No immediate episodes fetch)
            renderSeasonList(data.seasons, id);
            playerInterface.classList.remove('hidden'); tvControls.classList.remove('hidden');
            // Auto-select season 1
            const s1 = data.seasons.find(s => s.season_number === 1);
            if(s1) {
                currentSeason = 1; currentEpisode = 1;
                toggleSeason(1, id); // Fetch S1 immediately
            }
            updatePlayer();
        } catch (e) { showMessage("Failed to load show details.", true); }
    }

    function renderSeasonList(seasons, tvId) {
        seasonsContainer.innerHTML = '';
        seasons.forEach(s => {
            if(s.season_number === 0) return; // Skip specials usually
            const seasonHTML = `
                <div class="season-accordion">
                    <div class="season-header" onclick="toggleSeason(${s.season_number}, ${tvId}, this)">
                        <span>Season ${s.season_number}</span>
                        <i class="fas fa-chevron-down transition-transform duration-300"></i>
                    </div>
                    <div id="season-${s.season_number}-content" class="season-content">
                        <div class="p-4 text-center text-gray-500"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>
                    </div>
                </div>`;
            seasonsContainer.insertAdjacentHTML('beforeend', seasonHTML);
        });
    }

    async function toggleSeason(seasonNum, tvId, headerEl) {
        const contentId = `season-${seasonNum}-content`;
        const contentDiv = document.getElementById(contentId);
        
        // Toggle UI
        const isClosed = !contentDiv.classList.contains('open');
        // Close others (optional, cleaner UI)
        document.querySelectorAll('.season-content').forEach(el => el.classList.remove('open'));
        document.querySelectorAll('.season-header i').forEach(icon => icon.style.transform = 'rotate(0deg)');
        
        if(isClosed) {
            contentDiv.classList.add('open');
            if(headerEl) headerEl.querySelector('i').style.transform = 'rotate(180deg)';
            
            // Fetch episodes if not already loaded
            if(!contentDiv.dataset.loaded) {
                try {
                    const data = await fetchCached(`${BASE_TMDB_URL}/tv/${tvId}/season/${seasonNum}?api_key=${TMDB_API_KEY}`);
                    let html = '';
                    data.episodes.forEach(ep => {
                        const still = ep.still_path ? `${TMDB_STILL_SZ}${ep.still_path}` : 'https://placehold.co/120x68/333/999?text=No+Img';
                        html += `
                        <div class="episode-rich-item ${ep.episode_number === currentEpisode && currentSeason === seasonNum ? 'active' : ''}" 
                             onclick="selectEpisode(${seasonNum}, ${ep.episode_number}, this)">
                            <img src="${still}" class="ep-still" loading="lazy">
                            <div class="ep-info">
                                <div class="ep-title">${ep.episode_number}. ${ep.name}</div>
                                <div class="ep-overview">${ep.overview || 'No overview.'}</div>
                            </div>
                        </div>`;
                    });
                    contentDiv.innerHTML = html;
                    contentDiv.dataset.loaded = "true";
                } catch(e) { contentDiv.innerHTML = '<div class="p-2 text-red-500">Error loading episodes.</div>'; }
            }
        }
    }

    function renderDetails(data, title) {
        if (data.backdrop_path) pageBackground.style.backgroundImage = `url('${TMDB_BACKDROP_WEB}${data.backdrop_path}')`;
        detailsSection.classList.remove('hidden');
        
        const logo = (data.images?.logos?.find(l => l.iso_639_1 === 'en') || data.images?.logos?.[0])?.file_path;
        if(logo) { document.getElementById('detail-logo').src = `${TMDB_POSTER_XL}${logo}`; document.getElementById('detail-logo').style.display = 'block'; document.getElementById('detail-heading').style.display = 'none'; }
        else { document.getElementById('detail-logo').style.display = 'none'; document.getElementById('detail-heading').style.display = 'block'; document.getElementById('detail-heading').textContent = title; }

        document.getElementById('detail-poster').src = data.poster_path ? `${TMDB_POSTER_LG}${data.poster_path}` : '';
        document.getElementById('detail-tagline').textContent = data.tagline ? `"${data.tagline}"` : '';
        document.getElementById('detail-status').innerHTML = data.status ? `<i class="fas fa-info-circle mr-2"></i> ${data.status}` : '';
        document.getElementById('detail-overview').textContent = data.overview;
        document.getElementById('detail-date').querySelector('span').textContent = (data.release_date || data.first_air_date || '').substring(0,4);
        document.getElementById('detail-rating').querySelector('span').textContent = data.vote_average.toFixed(1);
        
        const genres = document.getElementById('detail-genres'); genres.innerHTML = '';
        data.genres?.forEach(g => genres.insertAdjacentHTML('beforeend', `<span class="px-3 py-1 bg-white/10 text-gray-200 text-xs rounded-full border border-white/10">${g.name}</span>`));
        
        const cast = document.getElementById('cast-list'); cast.innerHTML = '';
        data.credits?.cast?.slice(0, 10).forEach(c => {
            const img = c.profile_path ? `${TMDB_IMG_BASE_URL}${c.profile_path}` : 'https://placehold.co/80x80/333/999?text=?';
            cast.insertAdjacentHTML('beforeend', `<div class="cast-card" onclick="loadActorCredits(${c.id}, '${c.name.replace(/'/g,"\\'")}')"><img src="${img}" class="cast-img"><div class="cast-name">${c.name}</div><div class="cast-char">${c.character}</div></div>`);
        });
    }

    function buildUrl(template) {
        if (!TMDB_ID) return "#";
        let url = (mediaType === 'movie' ? template.movie : template.tv).replace(/\[ID\]/g, TMDB_ID);
        if (mediaType === 'movie' && url.includes('[IMDB_ID]')) url = url.replace(/\[IMDB_ID\]/g, IMDB_ID||'');
        if (mediaType === 'tv') url = url.replace(/\[S\]/g, currentSeason).replace(/\[E\]/g, currentEpisode);
        return url;
    }

    function updatePlayer() {
        if (!TMDB_ID) return;
        playerIframe.src = buildUrl(SERVER_URLS[currentServerIndex]);
        if (mediaType === 'tv') currentEpisodeInfo.textContent = `S${currentSeason}:E${currentEpisode} - Server ${currentServerIndex + 1}`;
        else currentEpisodeInfo.textContent = "Movie";
        
        // Highlight active episode in the open accordion
        document.querySelectorAll('.episode-rich-item').forEach(i => i.classList.remove('active'));
        const activeItem = document.querySelector(`.episode-rich-item[onclick*="(${currentSeason}, ${currentEpisode},"]`);
        if(activeItem) activeItem.classList.add('active');
        saveProgress();
    }

    function saveProgress() { if(TMDB_ID) localStorage.setItem('stream_progress', JSON.stringify({ mediaType, tmdbId: TMDB_ID, title: currentTitle, season: currentSeason, episode: currentEpisode, timestamp: Date.now() })); }
    async function loadProgress() {
        const saved = localStorage.getItem('stream_progress'); if (!saved) return;
        const p = JSON.parse(saved); if (Date.now() - p.timestamp > 86400000) return;
        if (confirm(`Resume watching "${p.title}"?`)) {
            await selectContent(p.tmdbId, p.title, p.mediaType);
            if(p.mediaType === 'tv') { currentSeason = p.season; currentEpisode = p.episode; toggleSeason(p.season, p.tmdbId).then(updatePlayer); }
        }
    }

    window.selectEpisode = (s, e, el) => { currentSeason = s; currentEpisode = e; updatePlayer(); };
    window.switchServer = (i, btn) => { currentServerIndex = i; document.querySelectorAll('.server-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); updatePlayer(); };
    window.nextEpisode = () => { /* Simplified Next Logic */ selectEpisode(currentSeason, currentEpisode + 1); }; // Ideally checks length
    window.openTrailerModal = async () => {
        if(!TMDB_ID) return; trailerModal.classList.remove('hidden'); trailerIframe.src = '';
        try {
            const data = await fetchCached(`${BASE_TMDB_URL}/${mediaType === 'movie' ? 'movie' : 'tv'}/${TMDB_ID}/videos?api_key=${TMDB_API_KEY}`);
            const trailer = data.results.find(v => v.type === 'Trailer') || data.results[0];
            if(trailer) trailerIframe.src = `https://www.youtube-nocookie.com/embed/${trailer.key}?autoplay=1&origin=${window.location.origin}&enablejsapi=1&rel=0`;
            else { showMessage("No trailer found", true); setTimeout(closeTrailerModal, 2000); }
        } catch(e){}
    }
    window.closeTrailerModal = () => { trailerModal.classList.add('hidden'); trailerIframe.src = ''; };
    window.openDownloadModal = () => { if(!TMDB_ID) return; document.getElementById('dl-link-1').href = buildUrl(DOWNLOAD_URLS.source1); document.getElementById('dl-link-2').href = buildUrl(DOWNLOAD_URLS.source2); downloadModal.classList.remove('hidden'); };
    window.closeDownloadModal = () => downloadModal.classList.add('hidden');

    document.getElementById('year').textContent = new Date().getFullYear();
    document.addEventListener('DOMContentLoaded', () => {
        const btnContainer = document.getElementById('server-buttons');
        SERVER_URLS.forEach((s, i) => { const btn = document.createElement('button'); btn.className = `server-btn ${i===0?'active':''}`; btn.textContent = s.name.split('(')[0].trim(); btn.onclick = () => switchServer(i, btn); btnContainer.appendChild(btn); });
        loadProgress(); loadTrending(); loadGenres();
    });
</script>
</body>
</html>
